# UI表示監査レポート（読み込み・更新チェック・書き込み）

作成日: 2025-11-07

本レポートは、起動直後のバージョンチェック、日次・月次データの読み込み、書き込み時のブロッキングUIの表示について、現状の「何を・いつ・どれくらい表示するか」を整理し、不要表示の削減方針を示します。

## 現状の表示一覧

- 起動時バージョン確認（`src/App.tsx`）
  - 表示内容: `LoadingModal` にて本文「Checking for new version...」を表示（ヘッダー「読み込み中」、フッター「画面を閉じずに…」も表示）。
  - 表示のタイミング: アプリ起動直後、Service Worker登録完了後に `navigator.serviceWorker.ready` を待機し、`CHECK_FOR_UPDATES` 送信直後。
  - 表示時間: タイムアウトは固定 `2.6秒`（`2600ms`）で自動クローズ。SWからの `VERSION_CHECK_RESULT` 受信時は即時クローズ。
  - 備考: データ読み込み（GAS/API）の並行実行中に完了するケースが多く、重複表示になりやすい。

- 日次データ読み込み（`src/components/KintaiForm.tsx`）
  - 表示内容: `LoadingModal` 本文「データを読み込み中... / Loading data...」、`subMessage`「最新の勤怠データを取得しています」。
  - 表示のタイミング: 日付選択・初期表示時にAPI/GASへ取得要求を送信し、`isDataLoading` が `true` の間表示。
  - 表示時間: サーバー応答時間およびネットワーク品質に依存（目安: 数百ms〜数秒）。固定タイムアウトなし。

- 月次データ読み込み（`src/components/MonthlyView.tsx`）
  - 表示内容: `LoadingModal` 本文「データを読み込み中... / Loading data...」、`subMessage` は「月次データ取得中」または「更新中です」。
  - 表示のタイミング: 月次データ取得・再取得（refresh）時に `isDataLoading || isRefreshing` の間表示。
  - 表示時間: サーバー応答時間に依存（目安: 数百ms〜数秒）。固定タイムアウトなし。

- 書き込み（保存処理、`src/components/KintaiForm.tsx`）
  - 表示内容: `LoadingModal` 見出し「書き込み中」、本文「書き込み中... / Writing...」、`subMessage`「サーバーへ保存しています」。
  - 表示のタイミング: ユーザーが保存操作を実行してから、サーバー応答（成功/失敗）までの間。
  - 表示時間: サーバー応答時間に依存（目安: 0.8〜3秒程度）。固定タイムアウトなし。ブロッキングは妥当。

## 無駄/過剰になりやすい表示

- 起動直後の「二重モーダル」
  - バージョンチェックの `LoadingModal` と、日次/月次のデータ読み込み `LoadingModal` が並立する可能性。ユーザー負担増。
- `subMessage` の定型文
  - 「最新の勤怠データを取得しています」「月次データ取得中」等は短時間処理では付加価値が薄く、情報過多。
- `LoadingModal` の固定フッター文言
  - 「画面を閉じずに…」は 2.6秒程度の表示には冗長。

## 方針（最小構成・必要十分な表示）

1) バージョンチェックモーダルの非表示化（起動時）
   - 起動直後はバージョンチェックを**非ブロッキング**で実施。データ読み込み中に裏で完了させる。
   - 更新ありの場合のみ「アップデート適用中」のブロッキング表示（短時間、本文1行）を出す。

2) 読み込み中は原則「非ブロッキング」
   - 日次/月次の取得はフォーム内のスケルトンやプレースホルダで十分。全画面モーダルは避ける。
   - モーダル採用は「取得が長引く/ユーザー操作を不可にしたい」ときのみ（閾値例: 1.2秒超過など）。

3) 書き込みは「ブロッキング」維持
   - 保存処理・更新適用など、整合性維持のためブロッキング表示は必要。本文は1行、`subMessage`/フッターは省略可能。

## 今後の具体的改善案（最小差分）

- `App.tsx`: 起動時の `showVersionCheckModal` を廃止し、SW更新チェックはバックグラウンドで実行。更新あり検出時のみ適用モーダル表示へ。
- `LoadingModal`: バージョンチェック・読み込み用途では `showHeader=false` / `showFooter=false` の簡素表示に切り替えられるよう props 拡張（既存互換維持）。
- `KintaiForm.tsx` / `MonthlyView.tsx`: 短時間の読み込みはモーダルを使わず、フォーム内スケルトンへ移行。

上記はユーザー方針「本当に必要な表示だけ」に沿う最小構成です。段階的に適用可能です。